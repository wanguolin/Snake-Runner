<!DOCTYPE html>
<html lang="zh-CN">
	<meta charset="UTF-8">
	<title>snake game</title>
	<table>
		<tr> <td rowspan="12"><canvas id="snake" style="border: 1px solid;" width="600" height="600"></canvas></td></tr>
		<tr> <td><input type=radio id= "playerNum" name="playerNum" VALUE="S" checked onclick="localStorage.setItem( 'player', 'S'), location.reload()">单人游戏</input> </td>
		<tr> <td><input type=radio id= "playerNum" name="playerNum" VALUE="M" onclick="localStorage.setItem( 'player', 'M'), location.reload()" >多人游戏</td> </input>  <tr>
		<tr> <td>ClientID：<input id="ClientID" type="text" value="Player"/></td></tr>
		<tr> <td>服务器IP地址：<input id="ip" type="text" value="127.0.0.1"/></td></tr>
		<tr> <td><textarea id="chat_log" name="chat_log" cols="30" rows="5">服务器信息</textarea> </td> </tr>
		<tr> <td><input type="text" id="chat" onkeydown="javascript:event.keyCode==13?send():1" />   </td></tr>
	</table>
	
	<script>
		var IsSingle = localStorage.getItem( 'player') == 'S' ? true : false, ip =  document.getElementById('ip').value, url = 'ws://'+ ip + ':8080/', w = new WebSocket( url), xx, yy, s1_x = 7, s1_y = 7, canvas = document.getElementById('snake'), cube = 7, context = canvas.getContext('2d'), s1_keycode = 39, s1_lastkey = s1_keycode, s1 = new Array([s1_x, s1_y], [s1_x += cube, s1_y], [s1_x += cube, s1_y], [s1_x += cube, s1_y], [s1_x += cube, s1_y], [s1_x += cube, s1_y], [s1_x += cube, s1_y]), s1_speed = 210;
		document.all['playerNum'][ IsSingle ? 1 : 0].checked = true;	
		document.addEventListener("keydown", function(e) { s1_keycode = (Math.abs(s1_keycode - e.keyCode) == 2 || e.keyCode < 37 || e.keyCode > 40) ? s1_keycode : e.keyCode;}, false);
		w.onerror = function(error){	alert( 'err');	}
		w.onmessage = function(msg){	document.getElementById('chat_log').innerHTML += msg.data + "\n" ;	}
		function send()				   {	w.send( document.getElementById('chat').value);		}
		setTimeout("chk_move_s1()", s1_speed), setInterval(draw,100), gen_food();
		
		function gen_food(){
			while( is_over( xx = Math.round( (canvas.width/cube)*Math.random())*cube, yy = Math.round( (canvas.width/cube)*Math.random())*cube));
		}
		function is_over( x, y){
			for( i = 0; i < s1.length - 1; i++)
				if( x == s1[i][0] && y == s1[i][1])
					return true;
			return ( x == 0 || x == canvas.width || y == 0 || y == canvas.height)? true : false;
		}
		function chk_move_s1() {
			switch( s1_keycode) {
				case 38 : s1.push([s1[s1.length-1][0], s1[s1.length-1][1] - cube]);
					break;
				case 40 : s1.push([s1[s1.length-1][0], s1[s1.length-1][1] + cube]);
					break;
				case 37 : s1.push([s1[s1.length-1][0] - cube, s1[s1.length-1][1]]);
					break;
				case 39 : s1.push([s1[s1.length-1][0] + cube, s1[s1.length-1][1]]);
					break;
			}
			is_over( s1[s1.length-1][0], s1[s1.length-1][1]) ? (alert( "Game Over"), location.reload()): setTimeout("chk_move_s1()", s1_speed), ( !(s1[s1.length-1][0] == xx && s1[s1.length-1][1] == yy) ? s1.shift() : (( (s1_speed - 100) > 0?s1_speed-=20:1), gen_food()));
		}
		function draw(){
			context.clearRect(0, 0, canvas.width, canvas.height);
			for( i = 0; i < s1.length; i++)
				context.fillRect(s1[i][0], s1[i][1], cube, cube);
			context.fillRect( xx, yy, cube, cube);
		}
	</script>
</html>